<?xml version='1.0' encoding='UTF-8'?>
<library>
    <addon plugin="cel.addons.questdef" >

    <quest name="findTheSecretNote">

        <state name="init">
          <oninit>
            <reward type="message" entity="world" id="ares.logentry">
              <par name="logid" string="SECNOTE_intro" />
              <par name="message" string="You must go find a secret note. Perhaps look in the basement?" />
            </reward>
            <reward type="newstate" state="watchout" />
          </oninit>
        </state>

        <state name="watchout">
          <trigger type="entersector">
            <fireon entity="player" sector="cellBasement" />
            <reward type="message" entity="world" id="ares.logentry">
              <par name="logid" string="SECNOTE_enterbasement" />
              <par name="message" string="As you enter the basement you get the impression that there was a fight recently. Perhaps you will find a clue here?" />
            </reward>
              <reward type="newstate" state="watchout" />
          </trigger>
          <trigger type="inventory">
            <fireon entity="player" child_entity="SecretNote" />
            <reward type="message" entity="world" id="ares.logentry">
              <par name="logid" string="SECNOTE_gotnote" />
              <par name="message" string="You pick up a note. This looks like the secret note you had to find." />
            </reward>
            <reward type="newstate" state="finish" />
          </trigger>
        </state>

        <state name="finish">
          <oninit>
            <reward type="message" entity="world" id="ares.finishquest" />
          </oninit>
        </state>

      </quest>


      <quest name="clickerObject">
	<state name="init">
	  <trigger type="message">
	    <fireon entity="$this" mask="ares.activate" />
	    <reward type="debugprint" message="=?counter" />
	    <reward type="changeproperty" entity="$this" property="counter" diff="1" />
	    <reward type="newstate" state="init" />
	  </trigger>
	</state>
      </quest>

      <quest name="glowQuest">
        <state name="init">
	  <oninit>
	    <reward sequence='animglow' type='sequence' entity='$this' entity_tag='glow' />
	  </oninit>
	  <trigger type="sequencefinish">
	    <fireon entity="$this" sequence="animglow" entity_tag='glow'/>
	    <reward type="newstate" state="init2" />
	  </trigger>
        </state>
	<state name="init2">
	  <oninit>
	    <reward type="newstate" state="init" />
	  </oninit>
	</state>
        <sequence name="animglow">
          <op entity="$this" type="ambientmesh" duration="$dur" >
	    <abscolor red="0" green="0" blue="1" />
          </op>
	  <delay time="$dur" />
          <op entity="$this" type="ambientmesh" duration="$dur" >
	    <abscolor red="1" green="0" blue="0" />
          </op>
	  <delay time="$dur" />
        </sequence>
      </quest>

    </addon>

  <addon plugin="cel.addons.celentitytpl" entityname="Crate"> <propclass name="pcobject.mesh" /> </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="Box">
      <propclass name="pcobject.mesh" />
      <propclass name="pctools.properties">
	<property name="counter" long="1" />
      </propclass>
      <propclass name="pclogic.wire">
	<action name="AddInput">
	  <par name="mask" string="ares.activate" />
	</action>
	<action name="AddOutput">
	  <par name="msgid" string="ares.teleport" />
	  <par name="entity" string="world" />
	  <par name="cell" string="$cell" />
	  <par name="pos" vector3="$pos" />
	</action>
      </propclass>
      <propclass name="pclogic.spawn">
        <action name="AddEntityTemplateType">
	  <par name="template" string="TinyBox" />
	</action>
        <action name="SetTiming">
	  <par name="repeat" bool="true" />
	  <par name="random" bool="true" />
	  <par name="mindelay" long="1000" />
	  <par name="maxdelay" long="5000" />
	</action>
        <action name="AddSpawnPosition">
	  <par name="sector" string="$sector" />
	  <par name="position" vector3="$pos" />
	</action>
	<action name="Inhibit">
	  <par name="count" long="5" />
	</action>
	<property name="spawnunique" bool="true" />
	<property name="namecounter" bool="false" />
      </propclass>
      <propclass name="pctools.inventory">
	<action name="AddTemplate">
	  <par name="name" string="SmallBox" />
	  <par name="amount" long="100" />
	</action>
	<action name="AddTemplate">
	  <par name="name" string="TinyBox" />
	  <par name="amount" long="1" />
	</action>
	<action name="AddTemplate">
	  <par name="name" string="MicroBox" />
	  <par name="amount" long="=50*100" />
	</action>
      </propclass>
      <propclass name="pclogic.quest" tag="note">
        <action name="NewQuest" >
          <par name="name" string="findTheSecretNote" />
        </action>
        <property name="state" string="init" />
      </propclass>
      <propclass name="pclogic.quest" tag="glow">
        <action name="NewQuest" >
          <par name="name" string="glowQuest" />
          <par name="dur" string="100" />
        </action>
        <property name="state" string="init" />
      </propclass>
      <propclass name="pclogic.quest" tag="clicker">
        <action name="NewQuest" >
          <par name="name" string="clickerObject" />
        </action>
        <property name="state" string="init" />
      </propclass>
  </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="SmallBox"> <propclass name="pcobject.mesh" /> </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="TinyBox"> <propclass name="pcobject.mesh" /> </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="MicroBox"> <propclass name="pcobject.mesh" /> </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="Sphere"> <propclass name="pcobject.mesh" /> </addon>
  <addon plugin="cel.addons.celentitytpl" entityname="SmallSphere"> <propclass name="pcobject.mesh" /> </addon>

  <addon plugin="cel.addons.dynamicworld.loader">
    <extension plugin="ares.dynworld.loader.factories"/>
    <dynworld name="zone" />
    <factory name="Crate" maxradius="0.5" imposterradius=".3" mass="6">
      <box />
      <attr name="category" value="Objects" />
    </factory>
    <factory name="Box" maxradius="0.5" imposterradius="-1" mass="4">
      <box />
      <attr name="category" value="Varia" />
    </factory>
    <factory name="SmallBox" maxradius="0.5" imposterradius="-1" mass="3">
      <box />
      <attr name="category" value="Varia" />
    </factory>
    <factory name="TinyBox" maxradius="0.5" imposterradius="-1" mass="2">
      <box />
      <attr name="category" value="Varia" />
    </factory>
    <factory name="MicroBox" maxradius="0.5" imposterradius="-1" mass="1">
      <box />
      <attr name="category" value="Varia" />
    </factory>
    <factory name="Sphere" maxradius="0.5" imposterradius="-1" mass="6">
      <sphere />
      <attr name="category" value="Varia" />
    </factory>
    <factory name="SmallSphere" maxradius="0.5" imposterradius="-1" mass="3">
      <sphere />
      <attr name="category" value="Varia" />
    </factory>
  </addon>
</library>
